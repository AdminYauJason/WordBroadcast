import{h as e,M as a,l as t,Z as s,c as r,w as o,W as A,i as l,o as n,a as i,e as u,b as c,d,F as g,p as v,_ as I,G as p,K as C,f as k,g as y,a0 as B,k as f,z as Q,t as m}from"./index-BFSQzsUc.js";import{s as U}from"./store.WVsknOEV.js";import{_ as w}from"./_plugin-vue_export-helper.BCo6x5W8.js";const h="data:image/png;base64,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",F=w({__name:"Robot",setup(w){const F=uni.requireNativePlugin("Lin-Float-Webview"),E=e([]),V=e(0),M=e(!1);let K=null;const x=e(""),T=e(null),R=e({speakingOutput:"",traderWords:"",tokens:0,isProcessing:!1,error:null,retryCount:0,maxRetries:3,retryInterval:15e3}),L=async()=>{if(!T.value)return null;try{R.value.isProcessing=!0,R.value.error=null;const e=await A({url:"http://47.102.98.100:8089/api/live/realtimeAnalysis",method:"post",data:{roomId:T.value.roomId,productInfo:T.value.productInfo}});if(200===e.statusCode){if(0===e.data.code)return R.value.speakingOutput=e.data.data.speakingOutput,R.value.tokens=e.data.data.tokens,R.value.retryCount=0,R.value.traderWords=e.data.data.traderWords,v.callFunction({name:"submitscript",data:{aiScript:R.value.speakingOutput,traderWords:R.value.traderWords,tokens:R.value.tokens}}),e.data.data.speakingOutput;if(202===e.data.code){if(R.value.retryCount<R.value.maxRetries)return R.value.retryCount++,await new Promise((e=>setTimeout(e,R.value.retryInterval))),await L();throw new Error("获取数据超时")}throw new Error(e.data.msg||"请求失败")}throw new Error("请求失败")}catch(e){return console.error("获取AI话术失败:",e),R.value.error=e.message,null}finally{R.value.isProcessing=!1}},P=async()=>{if(x.value=U.userInfo.mobile,!x.value)return R.value.error="未获取到用户手机号",!1;if(!(await(async()=>{try{const e=await v.callFunction({name:"getliveRecordData",data:{userphone:x.value}});if(e.result.success&&e.result.data){const a=Array.isArray(e.result.data)?e.result.data[0]:e.result.data;return T.value={roomId:a.roomId,productInfo:a.productInfo},console.log("获取到直播间信息:",T.value),!0}return console.error("获取数据失败:",e.result.message),R.value.error="未找到直播间信息",!1}catch(e){return console.error("调用云函数失败:",e),R.value.error="获取直播间信息失败",!1}})()))return!1;return await(async()=>{if(!T.value)return!1;try{return R.value.isProcessing=!0,R.value.error=null,200===(await A({url:"http://47.102.98.100:8089/api/live/realtimeAnalysis",method:"post",data:{roomId:T.value.roomId,productInfo:T.value.productInfo}})).statusCode?(M.value=!0,console.log("API激活成功"),!0):(R.value.error="API激活失败",!1)}catch(e){return console.error("API激活失败:",e),R.value.error="API激活请求失败",!1}finally{R.value.isProcessing=!1}})()},W=async()=>{const e=await A({url:`http://47.102.98.100:8089/api/stop/roomid=${T.value.roomId}`,method:"post"});K&&(clearInterval(K),K=null),200===e.statusCode&&(t({title:"已停止生成消息",icon:"none"}),console.log(e.data.message))},D=async()=>{if(!R.value.isProcessing)try{if(!M.value){if(!(await P()))return void W()}if(!(await L()))return void W();const e=`运营建议：\n${R.value.traderWords} \n\nAI话术建议：\n${R.value.speakingOutput}`,a={id:Date.now()+Math.random().toString(36).substr(2,9),text:e,isUser:!1,timestamp:Date.now(),tokens:R.value.tokens};E.value.push(a),I((()=>{V.value=100*E.value.length}))}catch(e){console.error("消息生成错误:",e),W(),t({title:"消息生成发生错误",icon:"none"})}},O=async()=>{try{await new Promise(((e,a)=>{F.applyPermission(e,a)}));const e=plus.io.convertLocalFileSystemURL("./././static/webview.html");F.create({url:`file://${e}`,width:300,height:200,x:p().windowWidth-350,y:p().windowHeight-450,dragType:2,transparent:!0},(e=>{console.log("悬浮窗创建成功:",e),F.show()}))}catch(e){console.error("创建悬浮窗失败:",e),t({title:"无法创建悬浮窗,请检查权限",icon:"none"})}};return a((async()=>{await P()?K=setInterval(D,2e3):t({title:R.value.error||"系统初始化失败",icon:"none"})})),s((()=>{K&&clearInterval(K),W()})),(e,a)=>{const t=C,s=k,A=l,v=y,I=B;return n(),r(A,{class:"container"},{default:o((()=>[i(A,{class:"navbar safe-area-inset-top"},{default:o((()=>[i(t,{src:h,mode:"aspectFit",class:"nav_image"}),i(A,{class:"nav_text"},{default:o((()=>[i(s,{class:"main_text"},{default:o((()=>[u("AI助手")])),_:1}),i(s,{class:"sub_text"},{default:o((()=>[u("你的智能助手，帮助你生成直播话术")])),_:1})])),_:1}),i(v,{class:"stop_button",onClick:W},{default:o((()=>[u("结束")])),_:1})])),_:1}),i(I,{class:"chat_content","scroll-y":"","scroll-top":V.value,"scroll-with-animation":!0},{default:o((()=>[i(A,{style:{height:"20rpx"}}),(n(!0),c(g,null,d(E.value,((e,a)=>(n(),r(A,{key:e.id||a,class:f(["message",[e.isUser?"user-message":"robot-message"]])},{default:o((()=>[e.isUser?Q("",!0):(n(),r(t,{key:0,src:h,mode:"aspectFit",class:"robot_avatar","lazy-load":""})),i(A,{class:f(["message_text",{"user-text":e.isUser}])},{default:o((()=>[u(m(e.text),1)])),_:2},1032,["class"])])),_:2},1032,["class"])))),128))])),_:1},8,["scroll-top"]),i(A,{class:"floating-button-wrapper safe-area-inset-bottom"},{default:o((()=>[i(v,{class:"floating-button",onClick:O,"hover-class":"button-hover"},{default:o((()=>[u(" 打开悬浮窗 ")])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-fbf16dc7"]]);export{F as default};
