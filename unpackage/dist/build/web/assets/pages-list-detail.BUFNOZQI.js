import{o as e,c as t,w as a,e as s,t as o,f as r,p as i,B as n,J as l,l as d,A as u,C as h,x as c,i as f,a as m,b as y,F as p,z as g,K as _,L as w}from"./index-BFSQzsUc.js";import{_ as M}from"./_plugin-vue_export-helper.BCo6x5W8.js";import{r as b}from"./uni-app.es.CkwVFIy4.js";import{_ as D,a as S}from"./uni-list.CxxeKbhT.js";import{_ as k}from"./unicloud-db.BY7xIv5G.js";import"./uni-icons.Di0C3xcn.js";function x(e,t=2){for(e+="";e.length<t;)e="0"+e;return e.slice(-t)}const j={yyyy:e=>x(e.year,4),yy:e=>x(e.year),MM:e=>x(e.month),M:e=>e.month,dd:e=>x(e.day),d:e=>e.day,hh:e=>x(e.hour),h:e=>e.hour,mm:e=>x(e.minute),m:e=>e.minute,ss:e=>x(e.second),s:e=>e.second,SSS:e=>x(e.millisecond,3),S:e=>e.millisecond};function v(e){return e instanceof Date?e:"string"==typeof e?e.indexOf("T")>-1?new Date(e):new Date(e.replace(/-/g,"/")):new Date(e)}function N(e,{locale:t="zh",threshold:a=[6e4,36e5],format:s="yyyy/MM/dd hh:mm:ss"}){if("-"===e)return e;if(!e&&0!==e)return"";const o={zh:{year:"年",month:"月",day:"天",hour:"小时",minute:"分钟",second:"秒",ago:"前",later:"后",justNow:"刚刚",soon:"马上",template:"{num}{unit}{suffix}"},en:{year:"year",month:"month",day:"day",hour:"hour",minute:"minute",second:"second",ago:"ago",later:"later",justNow:"just now",soon:"soon",template:"{num} {unit} {suffix}"}},r=o[t]||o.zh;let i,n,l=v(e),d=l.getTime()-Date.now(),u=Math.abs(d);if(u<a[0])return d<0?r.justNow:r.soon;if(u>=a[1])return function(e,t="yyyy/MM/dd hh:mm:ss"){if(!e&&0!==e)return"";const a={year:(e=v(e)).getFullYear(),month:e.getMonth()+1,day:e.getDate(),hour:e.getHours(),minute:e.getMinutes(),second:e.getSeconds(),millisecond:e.getMilliseconds()},s=/yyyy|yy|MM|M|dd|d|hh|h|mm|m|ss|s|SSS|SS|S/;let o=!0,r=t;for(;o;)o=!1,r=r.replace(s,(function(e){return o=!0,j[e](a)}));return r}(l,s);let h=r.later;d<0&&(h=r.ago,d=-d);const c=Math.floor(d/1e3),f=Math.floor(c/60),m=Math.floor(f/60),y=Math.floor(m/24),p=Math.floor(y/30),g=Math.floor(p/12);switch(!0){case g>0:i=g,n=r.year;break;case p>0:i=p,n=r.month;break;case y>0:i=y,n=r.day;break;case m>0:i=m,n=r.hour;break;case f>0:i=f,n=r.minute;break;default:i=c,n=r.second}return"en"===t&&(1===i?i="a":n+="s"),r.template.replace(/{\s*num\s*}/g,i+"").replace(/{\s*unit\s*}/g,n).replace(/{\s*suffix\s*}/g,h)}const R=M({name:"uniDateformat",props:{date:{type:[Object,String,Number],default:()=>"-"},locale:{type:String,default:"zh"},threshold:{type:Array,default:()=>[0,0]},format:{type:String,default:"yyyy/MM/dd hh:mm:ss"},refreshRate:{type:[Number,String],default:0}},data:()=>({refreshMark:0}),computed:{dateShow(){return this.refreshMark,N(this.date,{locale:this.locale,threshold:this.threshold,format:this.format})}},watch:{refreshRate:{handler(){this.setAutoRefresh()},immediate:!0}},methods:{refresh(){this.refreshMark++},setAutoRefresh(){clearInterval(this.refreshInterval),this.refreshRate&&(this.refreshInterval=setInterval((()=>{this.refresh()}),parseInt(this.refreshRate)))}}},[["render",function(i,n,l,d,u,h){const c=r;return e(),t(c,null,{default:a((()=>[s(o(h.dateShow),1)])),_:1})}]]),L=i.database().collection("read-news-log");const I=M({data:()=>({id:"",title:"title",field:"user_id.nickname,user_id._id,avatar,excerpt,last_modify_date,comment_count,like_count,title,content",formData:{noData:'<p style="text-align:center;color:#666">详情加载中...</p>'}}),computed:{uniStarterConfig:()=>n().globalData.config,where(){return`_id =="${this.id}"`}},onLoad(e){e.id&&(this.id=e.id),e.title&&(this.title=e.title,l({title:e.title}))},onReady(){this.id?this.$refs.detail.loadData():d({icon:"none",title:this.$t("listDetail.newsErr")})},onNavigationBarButtonTap(e){"share"==e.type&&this.shareClick()},methods:{$log(...e){console.log("args",...e,this.id)},setReadNewsLog(){let e={article_id:this.id,last_time:Date.now()},t=u("readNewsLog")||[],a=-1;t.forEach((({article_id:t},s)=>{t==e.article_id&&(a=s)})),-1===a?t.push(e):t.splice(a,1,e),h("readNewsLog",t),console.log(t)},setFavorite(){if(i.getCurrentUserInfo().tokenExpired<Date.now())return console.log("未登录用户");let e=this.id,t=Date.now();console.log({article_id:e,last_time:t}),L.where(`"article_id" == "${e}" && "user_id"==$env.uid`).update({last_time:t}).then((({result:{updated:t}})=>{console.log("updated",t),t||L.add({article_id:e}).then((e=>{console.log(e)})).catch((e=>{console.log(e)}))})).catch((e=>{console.log(e)}))},loadData(e){""==this.title&&e[0].title&&(this.title=e[0].title,l({title:e[0].title})),this.setReadNewsLog()},followClick(){d({title:this.$t("listDetail.follow"),icon:"none"})}}},[["render",function(i,n,l,d,u,h){const M=f,x=b(c("uni-dateformat"),R),j=b(c("uni-list-item"),D),v=b(c("uni-list"),S),N=_,L=r,I=w,$=b(c("unicloud-db"),k);return e(),t(M,{class:"article"},{default:a((()=>[m(M,{class:"article-title"},{default:a((()=>[s(o(u.title),1)])),_:1}),m($,{options:u.formData,collection:"opendb-news-articles,uni-id-users",field:u.field,getone:!0,where:h.where,manual:!0,ref:"detail",foreignKey:"opendb-news-articles.user_id",onLoad:h.loadData},{default:a((({data:t,loading:r,error:i,options:n})=>[!r&&t?(e(),y(p,{key:0},[m(v,{border:!1},{default:a((()=>[m(j,{thumbSize:"lg",thumb:t.image},{body:a((()=>[m(M,{class:"header-content"},{default:a((()=>[m(M,{class:"uni-title"},{default:a((()=>[s(o(t.user_id&&t.user_id[0]&&t.user_id[0].nickname||"未知"),1)])),_:2},1024)])),_:2},1024)])),footer:a((()=>[m(M,{class:"footer"},{default:a((()=>[m(M,{class:"uni-note"},{default:a((()=>[s("更新于 "),m(x,{date:t.last_modify_date,format:"yyyy-MM-dd hh:mm",threshold:[6e4,2592e6]},null,8,["date"])])),_:2},1024)])),_:2},1024)])),_:2},1032,["thumb"])])),_:2},1024),m(M,{class:"banner"},{default:a((()=>[m(N,{class:"banner-img",src:t.avatar,mode:"widthFix"},null,8,["src"]),m(M,{class:"banner-title"},{default:a((()=>[m(L,{class:"uni-ellipsis"},{default:a((()=>[s(o(t.excerpt),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),m(M,{class:"article-content"},{default:a((()=>[m(I,{nodes:t.content},null,8,["nodes"])])),_:2},1024)],64)):g("",!0)])),_:1},8,["options","field","where","onLoad"])])),_:1})}],["__scopeId","data-v-9a0df2be"]]);export{I as default};
