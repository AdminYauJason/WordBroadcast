import{p as e,a1 as t,l as a,N as s,O as o,m as n,x as l,c,w as i,i as r,o as u,a as d,e as p,t as m,b as h,d as f,F as y,f as g,g as _,I as w,k as P,z as b,K as k}from"./index-BFSQzsUc.js";import{_ as I}from"./uni-icons.Di0C3xcn.js";import{r as x}from"./uni-app.es.CkwVFIy4.js";import{_ as M}from"./uni-popup.Vqszy5FZ.js";import{_ as A}from"./_plugin-vue_export-helper.BCo6x5W8.js";const R=e.database();const $=A({data:()=>({userInfo:{},customAmount:"",transactions:[],selectedPayMethod:"wxpay",loading:!1,paymentMethods:[{id:"wxpay",name:"微信支付",icon:"/static/wallet/wxpay.png"},{id:"alipay",name:"支付宝",icon:"/static/wallet/alipay.png"}]}),computed:{canRecharge(){const e=Number(this.customAmount);return e>=1&&e<=5e4}},onLoad(){this.getUserInfo(),this.getTransactions()},onPullDownRefresh(){Promise.all([this.getUserInfo(),this.getTransactions()]).finally((()=>{t()}))},methods:{async getUserInfo(){try{const{result:e}=await R.collection("uni-id-users").where("'_id' == $cloudEnv_uid").field("balance").get();e.data.length>0&&(this.userInfo=e.data[0])}catch(e){console.error(e),a({title:"获取用户信息失败",icon:"none"})}},async getTransactions(){try{const{result:e}=await R.collection("transactions").where("'user_id' == $cloudEnv_uid").orderBy("createTime","desc").limit(5).get();this.transactions=e.data}catch(e){console.error(e),a({title:"获取交易记录失败",icon:"none"})}},selectPayMethod(e){this.selectedPayMethod=e},showRechargePopup(){this.$refs.rechargePopup.open()},closeRechargePopup(){this.$refs.rechargePopup.close(),this.resetRechargeForm()},resetRechargeForm(){this.customAmount="",this.selectedPayMethod="wxpay"},handleAmountInput(e){const t=e.detail.value;this.customAmount=t.replace(/[^\d.]/g,"").replace(/\.{2,}/g,".").replace(/^(\d+)\.(\d\d).*$/,"$1.$2")},async confirmRecharge(){const t=Number(this.customAmount);if(t)try{this.loading=!0,s({title:"请求支付中..."});const{result:a}=await e.callFunction({name:"recharge",data:{amount:t,payMethod:this.selectedPayMethod}});if(0!==a.code)throw new Error(a.message);"wxpay"===this.selectedPayMethod?await this.processWxPay(a.payInfo):await this.processAliPay(a.payInfo)}catch(n){console.error(n),a({title:"支付失败："+n.message,icon:"none"})}finally{o(),this.loading=!1,this.closeRechargePopup()}else a({title:"请输入充值金额",icon:"none"})},processWxPay(e){return new Promise(((t,s)=>{uni.requestPayment({provider:"wxpay",...e,success:e=>{a({title:"充值成功",icon:"success"}),this.getUserInfo(),this.getTransactions(),t(e)},fail:e=>{s(new Error("支付取消或失败"))}})}))},processAliPay(e){return new Promise(((t,s)=>{uni.requestPayment({provider:"alipay",...e,success:e=>{a({title:"充值成功",icon:"success"}),this.getUserInfo(),this.getTransactions(),t(e)},fail:e=>{s(new Error("支付取消或失败"))}})}))},formatDate(e){const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`},navigateToFullHistory(){n({url:"/pages/wallet/transaction-history"})}}},[["render",function(e,t,a,s,o,n){const A=g,R=r,$=_,C=x(l("uni-icons"),I),v=w,T=k,F=x(l("uni-popup"),M);return u(),c(R,{class:"wallet-container"},{default:i((()=>[d(R,{class:"balance-card"},{default:i((()=>[d(R,{class:"balance-header"},{default:i((()=>[d(A,{class:"balance-title"},{default:i((()=>[p("我的余额")])),_:1}),d(R,{class:"balance-amount"},{default:i((()=>[d(A,{class:"currency"},{default:i((()=>[p("¥")])),_:1}),d(A,{class:"amount"},{default:i((()=>[p(m(o.userInfo.balance||"0.00"),1)])),_:1})])),_:1})])),_:1}),d(R,{class:"action-buttons"},{default:i((()=>[d($,{class:"action-btn recharge-btn",onClick:n.showRechargePopup},{default:i((()=>[p("充值")])),_:1},8,["onClick"])])),_:1})])),_:1}),d(R,{class:"transaction-history"},{default:i((()=>[d(R,{class:"section-title"},{default:i((()=>[d(A,null,{default:i((()=>[p("交易记录")])),_:1}),d(A,{class:"more-text",onClick:n.navigateToFullHistory},{default:i((()=>[p("查看全部")])),_:1},8,["onClick"])])),_:1}),d(R,{class:"history-list"},{default:i((()=>[0===o.transactions.length?(u(),c(R,{key:0,class:"empty-state"},{default:i((()=>[d(C,{type:"info",size:"48",color:"#999"}),d(A,{class:"empty-text"},{default:i((()=>[p("暂无交易记录")])),_:1})])),_:1})):(u(!0),h(y,{key:1},f(o.transactions,((e,t)=>(u(),c(R,{key:t,class:"transaction-item"},{default:i((()=>[d(R,{class:"transaction-info"},{default:i((()=>[d(A,{class:"transaction-type"},{default:i((()=>[p(m(e.type),1)])),_:2},1024),d(A,{class:"transaction-time"},{default:i((()=>[p(m(n.formatDate(e.createTime)),1)])),_:2},1024)])),_:2},1024),d(A,{class:P(["transaction-amount",e.amount>0?"income":"expense"])},{default:i((()=>[p(m(e.amount>0?"+":"")+m(e.amount),1)])),_:2},1032,["class"])])),_:2},1024)))),128))])),_:1})])),_:1}),d(F,{ref:"rechargePopup",type:"bottom"},{default:i((()=>[d(R,{class:"popup-content"},{default:i((()=>[d(R,{class:"popup-header"},{default:i((()=>[d(A,{class:"popup-title"},{default:i((()=>[p("充值")])),_:1}),d(R,{class:"close-btn",onClick:n.closeRechargePopup},{default:i((()=>[d(C,{type:"close",size:"20",color:"#666"})])),_:1},8,["onClick"])])),_:1}),d(R,{class:"popup-body"},{default:i((()=>[d(R,{class:"input-group"},{default:i((()=>[d(A,{class:"label"},{default:i((()=>[p("充值金额")])),_:1}),d(R,{class:"amount-input"},{default:i((()=>[d(A,{class:"currency-symbol"},{default:i((()=>[p("¥")])),_:1}),d(v,{type:"digit",modelValue:o.customAmount,"onUpdate:modelValue":t[0]||(t[0]=e=>o.customAmount=e),placeholder:"请输入充值金额",class:"amount-field",maxlength:"8",onInput:n.handleAmountInput},null,8,["modelValue","onInput"])])),_:1})])),_:1}),d(R,{class:"payment-methods"},{default:i((()=>[(u(!0),h(y,null,f(o.paymentMethods,(e=>(u(),c(R,{class:P(["payment-method",{selected:o.selectedPayMethod===e.id}]),key:e.id,onClick:t=>n.selectPayMethod(e.id)},{default:i((()=>[d(T,{src:e.icon,mode:"aspectFit",class:"method-icon"},null,8,["src"]),d(A,{class:"method-name"},{default:i((()=>[p(m(e.name),1)])),_:2},1024),o.selectedPayMethod===e.id?(u(),c(C,{key:0,type:"checkmarkempty",size:"20",color:"#07c160"})):b("",!0)])),_:2},1032,["class","onClick"])))),128))])),_:1}),d($,{class:"confirm-btn",onClick:n.confirmRecharge,disabled:!n.canRecharge||o.loading,loading:o.loading},{default:i((()=>[p(" 确认充值 ")])),_:1},8,["onClick","disabled","loading"])])),_:1})])),_:1})])),_:1},512)])),_:1})}],["__scopeId","data-v-3eab5543"]]);export{$ as default};
